/*! 11-15-2015 */
function debug_phishing(a){console.log(a)}function checkPhishingStatus(){function a(a){for(var b=a.textContent.toLowerCase(),c=0;c<e.length;c++)if(-1!=b.indexOf(e[c]))return!0;return a.querySelector("input[type=password]")?(debug_phishing("sensitive form found, decresing threshold"),k*=.68,!0):2==a.querySelectorAll("input[type=text], input[type=password]").length?(debug_phishing("possibly sensitive form, checking but increasing minScore"),k*=1.15,!0):!1}function b(a){var b=a;tldRegex.lastIndex=0;var c=a.split(".");return tldRegex.test(a)&&(b=c[c.length-2]+"."+c[c.length-1]),0==b.indexOf("www.")&&(b=b.replace("www.","")),b}if(!document.querySelector("input[type=password], form"))return!1;for(var c=performance.now(),d=["secure","account","webscr","login","ebayisapi","signing","banking","confirm"],e=["password","creditcard","credit card","security code","expiration date","card type"],f=["adobeid-na1.services.adobe.com","login.live.com","www.phishtank.com","www.wellsfargo.com","online.citi.com",,"www.bankofamerica.com","my.hrw.com","www.fastcompany.com"],g=0;g<f.length;g++)if(f[g]===window.location.hostname)return;var h=window.location.toString(),i=document.body.textContent,j=document.body.innerHTML,k=1.25,l=0,m=document.createElement("a");doubleDomainRegex.test(h)&&(debug_phishing("found misleading domain"),l+=.2),"https:"!=window.location.protocol&&(debug_phishing("no https"),l+=.15),window.location.host.length>25&&(debug_phishing("long hostname detected"),l+=.005*window.location.host.length,console.log("score",l)),h.split("?")[0].length>100&&(debug_phishing("long window location detected"),l+=Math.min(5e-4*window.location.toString().length,.2)),h.split("?")[0].split(".").length>5&&(debug_phishing("high number of . characters detected"),l+=Math.min(.03*h.split("?")[0].split(".").length,.2)),window.location.pathname.length>25&&(debug_phishing("paths detected"),l+=.1),d.forEach(function(a){-1!=h.toLowerCase().indexOf(a)&&(debug_phishing("detected sensitive word found in location"),l+=.025)});var n=document.querySelectorAll("form"),o=0,p=!1,q=!1;if(n){for(var g=0;g<n.length;g++){var r=n[g],s=r.textContent;if(a(r)){var t=r.getAttribute("action");if(t&&-1==h.split("?")[0].indexOf(t.split("?")[0])){o+=r.innerHTML.length,r.getAttribute("onsubmit")&&(debug_phishing("js html attribute onsubmit detected"),l+=.05);var u=t.split("/").length-1;2>u?(debug_phishing("form with simple path for action detected"),q=!0):3>u&&(debug_phishing("non-absolute form path detected"),l+=.1),-1!=t.indexOf(".php")&&(debug_phishing("php file action found"),l+=.075),m.href=t,b(m.hostname)!=b(window.location.hostname)&&(debug_phishing("submitting form to xdomain"),l+=.35),"https:"!=m.protocol&&(debug_phishing("submitting form without https"),l+=.15),d.forEach(function(a){-1!=s.indexOf(a)&&(debug_phishing("sensitive word found in form"),l+=.02)})}else debug_phishing("form without action detected"),p=!0}}1==p&&(l+=.6),1==q&&(l+=.75)}for(var v=document.querySelectorAll("a, area[href]"),w={},x={},y=0,z=0,g=0;g<v.length;g++){var A=v[g].getAttribute("href");A&&("#"!=A||v[g].onclick)?(0==A.indexOf("javascript:")&&z++,m.href=v[g].href,w[m.host]=w[m.host]+1||1,x[A]=x[A]+1||1):y++}var B=0,C=0,D=b(window.location.host);for(var E in w)if(C+=w[E],b(E)!=D){if(w[E]>4&&E){debug_phishing("found "+w[E]+" links that point to domain "+E),l+=Math.min(.05+.025*w[E],.4);break}}else B+=w[E];(C>2&&0==B||C>5&&.15>B/C)&&(debug_phishing("links go to external domain"),l+=Math.min(.05*(C-B),.2)),(y>5||C>2&&y/C>.5)&&(debug_phishing("counted "+y+" empty links"),l+=Math.min(.02*y,.2)),z>3&&(debug_phishing("counted "+z+" javascript links"),l+=.1),document.querySelector("input[type=password]")&&(k=.85);var F=j.length;o>50&&1e3>o&&.075>o/F?(debug_phishing("forms are very minor part of page, increasing minScore"),k+=Math.min(1.1-o/F,1.1)):o>50&&3500>o&&.14>o/F&&(debug_phishing("forms are minor part of page, increasing minScore (small)"),debug_phishing(o),debug_phishing(F),k+=.2),n.length>3&&(k+=Math.min(.05*n.length,.2)),i.length<500&&(debug_phishing("small amount of body text, multiplying score"),l*=1.4),console.log("min "+k),console.log("status",l,n,x,w),l>k&&ipc.sendToHost("phishingDetected");var G=performance.now();return console.log("phishing scan took "+(G-c)+" milliseconds"),!0}var ipc=require("ipc"),webFrame=require("web-frame");ipc.on("sendData",function(){for(var a=["P","B","I","U","H1","H2","H3","A","PRE","CODE","SPAN"],b=["LINK","STYLE","SCRIPT","NOSCRIPT"],c="",d=document.querySelectorAll("*"),e=0;e<d.length;e++){var f=d[e];(-1!=a.indexOf(f.tagName)||!f.childElementCount&&-1==b.indexOf(f.tagName))&&(c+=" "+f.textContent)}var g=document.querySelector("meta[name=description]");g&&(c+=" "+g.content),c=c.replace(/[\n\t]/g,"");var h,i,j,k=document.querySelector("[itemprop=price], .price, .offer-price, #priceblock_ourprice, .discounted-price"),l=document.querySelector("[itemprop=priceCurrency], [property=priceCurrency]");k&&(h=k.textContent),/\d/g.test(h)||(h=void 0),h&&-1==h.indexOf("$")&&l&&(h=(l.content||l.textContent).replace("USD","$")+h);var m=document.querySelector('.star-img, .rating, [itemprop="ratingValue"], [property="ratingValue"]');m||(m=document.querySelector('[class^="rating"], [class^="review"]')),m&&(i=m.title||m.alt||m.content||m.textContent,i=i.replace("rating","").replace("stars","").replace("star","").trim(),console.log("r: "+i),i&&/\d+$/g.test(i)&&(i+=" stars"));var n=document.querySelector('[itemprop="location"], [itemprop="address"]');if(!n)var n=document.querySelector(".adr, .addr, .address");n&&(j=n.textContent.trim()),j&&/,?\d{5}$/g.test(j)&&(j=j.replace(/,?\d{5}$/g,"")),console.log("rating: "+i),console.log("price: "+h),console.log("location: "+j),ipc.sendToHost("bookmarksData",{url:window.location.toString(),title:document.title||"",text:c,extraData:{metadata:{price:h,rating:i,location:j}}})});var contextMenuDefaultPrevented=!1;window.addEventListener("contextmenu",function(a){contextMenuDefaultPrevented=a.defaultPrevented}),ipc.on("getContextData",function(a){if(!contextMenuDefaultPrevented){var b=document.elementFromPoint(a.x,a.y);if(b){var c=b.href||b.src;if("IMG"==b.tagName||"PICTURE"==b.tagName)var d=b.src}ipc.sendToHost("contextData",{selection:window.getSelection().toString(),src:c,image:d})}});var tldRegex=/\.(com|net|org|edu|gov|mil)$/g,doubleDomainRegex=/\.(com|net|org|edu|gov|mil|uk|ca|jp|fr|au|us|ru|ch|it|nl|de|es)(\.|-).*(com|net|org|edu|gov|mil|uk|ca|jp|fr|au|us|ru|ch|it|nl|de|es)/g;window.addEventListener("load",function(){setTimeout(checkPhishingStatus,1e3)}),document.addEventListener("DOMContentLoaded",checkPhishingStatus),window.addEventListener("load",function(a){var b=document.querySelectorAll("p"),c=0;if(b){for(var d=0;d<b.length;d++)c+=Math.max(b[d].textContent.length-100,-30);window._browser_readerScore=c,(c>650||document.querySelector("article")&&c>200)&&(setTimeout(function(){ipc.sendToHost("canReader")},500),setTimeout(function(){ipc.sendToHost("canReader")},2500))}}),window.addEventListener("mousewheel",function(a){a.deltaY>7||a.deltaY<-7||documentUnloaded||(totalMouseMove+=a.deltaX,-150>totalMouseMove?(doneNavigating=!0,window.history.back(),documentUnloaded=!0,console.log("going back"),setTimeout(function(){documentUnloaded=!1},3e3)):totalMouseMove>100&&(console.log("going forward"),documentUnloaded=!0,window.history.go(1),console.log(a),setTimeout(function(){documentUnloaded=!1},3e3)))}),setInterval(function(){totalMouseMove=0},4e3),window._browser_zoomLevel=0,window._browser_maxZoom=9,window._browser_minZoom=-8,ipc.on("zoomIn",function(){_browser_maxZoom>_browser_zoomLevel&&(_browser_zoomLevel+=1),webFrame.setZoomLevel(_browser_zoomLevel)}),ipc.on("zoomOut",function(){_browser_minZoom<_browser_zoomLevel&&(_browser_zoomLevel-=1),webFrame.setZoomLevel(_browser_zoomLevel)}),ipc.on("zoomReset",function(){_browser_zoomLevel=0,webFrame.setZoomLevel(_browser_zoomLevel)});var totalMouseMove=0;window.documentUnloaded=!1;