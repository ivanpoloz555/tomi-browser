/*! 04-10-2016 */
function getBookmarksText(a,b){var c=a.cloneNode(a,!0),d=c.body.querySelectorAll('link, style, script, noscript, .visually-hidden, .visuallyhidden, [role=presentation], [hidden], [style*="display:none"], .ad, .dialog, .modal');if(d)for(var e=0;e<d.length;e++)d[e].parentNode.removeChild(d[e]);var f=c.body.querySelectorAll("aside, .sidebar, #sidebar");if(f)for(var e=0;e<f.length;e++)f[e].textContent.length/c.body.textContent.length<.075&&f[e].parentNode.removeChild(f[e]);for(var g=c.body.querySelectorAll("*"),h="",e=0;e<g.length;e++)g[e].insertAdjacentHTML("beforeend"," ");h=c.body.textContent;var i=c.querySelector("meta[name=description]");return i&&(h+=" "+i.content),h=h.replace(/[\n\t]/g,""),h=h.replace(/\s{2,}/g," "),h=h.replace(/<.*?>/g,"")}function debug_phishing(a){console.log(a)}function checkPhishingStatus(){function a(a){if(a.querySelector("input[type=password]"))return debug_phishing("form with password input found"),t=!0,!0;if(2==a.querySelectorAll("input[type=text], input[type=password]").length)return debug_phishing("possibly sensitive form, checking but increasing minScore"),j*=1.5,t=!0,!0;if(!a.querySelector("input"))return debug_phishing("empty form found, checking but not counting as sensitive"),j+=.35,!0;for(var b=a.textContent.toLowerCase(),c=0;c<e.length;c++)if(-1!=b.indexOf(e[c]))return debug_phishing("sensitive word found in form, checking"),t=!0,j+=.15,!0;return!1}function b(a){var b=a;tldRegex.lastIndex=0;var c=a.split(".");return tldRegex.test(a)&&(b=c[c.length-2]+"."+c[c.length-1]),0==b.indexOf("www.")&&(b=b.replace("www.","")),b}if(!document.querySelector("input[type=password], form"))return!1;var c=performance.now();document.querySelector("input[type=password]")&&(j=.65);for(var d=["secure","account","webscr","login","ebayisapi","signing","banking","confirm"],e=["password","creditcard","credit card","security code","expiration date","card type","social security","income tax","date of birth","joint return"],f=["adobeid-na1.services.adobe.com","www.zdnet.com"],g=0;g<f.length;g++)if(f[g]===window.location.hostname)return void console.log("domain is whitelisted, not checking");var h=window.location.toString(),i=(document.body.textContent,document.body.innerHTML),j=1.25,k=0,l=document.createElement("a");doubleDomainRegex.test(h)&&(debug_phishing("found misleading domain"),k+=.0075*window.location.toString().length),"https:"!=window.location.protocol&&"file:"!=window.location.protocol&&(debug_phishing("no https"),k+=.15,"data:"==window.location.protocol&&(debug_phishing("data: protocol found"),k+=.25)),window.location.host.length>25&&(debug_phishing("long hostname detected"),k+=.0075*window.location.host.length),h.split("?")[0].length>75&&(debug_phishing("long window location detected"),k+=Math.min(1e-4*window.location.toString().length,.2)),h.split("/").length>5&&(debug_phishing("long path found"),k+=Math.max(.05*h.split("/").length,.25)),window.location.hostname.split(".").length>3&&window.location.hostname.length>20&&(debug_phishing("high number of . characters detected"),k+=Math.min(.03*h.split("?")[0].split(".").length,.2)),window.location.pathname.length>25&&(debug_phishing("paths detected"),k+=Math.min(.05+.002*window.location.pathname.length,.3)),o&&window.location.pathname.length<20&&window.location.hostname.replace("www.","").length<18&&(debug_phishing("short root domain found, increasing minScore"),j+=.3+.05*(18-window.location.hostname.length)-.01*window.location.pathname.length);var m=["com","org","edu","mil","gov"],n=window.location.hostname.split(".").reverse()[0],o=-1!=m.indexOf(n);window.location.hostname&&!o&&(k+=.15,debug_phishing("unusual domain ending found, increasing score")),d.forEach(function(a){-1!=h.toLowerCase().indexOf(a)&&(debug_phishing("detected sensitive word found in location"),k+=.025)});var p=document.querySelectorAll("form"),q=0,r=!1,s=!1,t=!1;if(p){for(var g=0;g<p.length;g++){var u=p[g],v=u.innerHTML.toLowerCase();if(a(u)){var w=u.getAttribute("action");if(w&&-1==h.split("?")[0].indexOf(w.split("?")[0])){q+=u.innerHTML.length,(u.getAttribute("onsubmit")&&"return false"!=u.getAttribute("onsubmit")||u.getAttribute("onkeydown")||u.getAttribute("onkeypress")||u.getAttribute("onkeyup"))&&(debug_phishing("js html inline attributes detected"),k+=.05);var x=w.replace(window.location.toString(),"").replace(window.location.pathname,"").split("/").length-1;0!=w.indexOf("javascript:")&&2>x?(debug_phishing("form with simple path for action detected"),s=!0):3>x&&(debug_phishing("non-absolute form path detected"),k+=.1),-1!=w.indexOf(".php")&&(debug_phishing("php file action found"),k+=.075),l.href=w,0!=w.indexOf("javascript:")&&b(l.hostname)!=b(window.location.hostname)&&(debug_phishing("submitting form to xdomain"),k+=.7),"https:"!=l.protocol&&(debug_phishing("submitting form without https"),k+=.15),d.forEach(function(a){-1!=v.indexOf(a)&&(debug_phishing("sensitive word found in form"),k+=.02)})}else debug_phishing("form without action detected"),r=!0}}1==r&&(k+=.4,k+=Math.min(.2,1e-4*q)),1==s&&(k+=.75)}t||document.querySelector("input[type=password]")||(debug_phishing("no sensitive forms found, increasing minScore"),j+=.33);for(var y=document.querySelectorAll("a, area[href]"),z={},A={},B=0,C=0,g=0;g<y.length;g++){var D=y[g].getAttribute("href");D&&("#"!=D||y[g].onclick)?(0==D.indexOf("javascript:")&&C++,l.href=y[g].href,z[l.host]=z[l.host]+1||1,A[D]=A[D]+1||1):B++}var E=0,F=0,G=b(window.location.host);for(var H in z)if(F+=z[H],b(H)!=G){if(z[H]>4&&H&&z[H]/F>.25){debug_phishing("found "+z[H]+" links that point to domain "+H),k+=Math.min(.1*z[H],.25);break}}else E+=z[H];(F>2&&0==E||F>5&&.15>E/F)&&(debug_phishing("links go to external domain"),k+=Math.min(.1+.1*(F-E),.5)),(B>9||F>2&&B/F>.5)&&(debug_phishing("counted "+B+" empty links"),k+=Math.min(.02*B,.2)),C>3&&(debug_phishing("counted "+C+" javascript links"),k+=.1);var I=i.length;q>50&&1e3>q&&.075>q/I?(debug_phishing("forms are very minor part of page, increasing minScore"),j+=Math.min(1.15-q/I,1.2)):q>50&&3500>q&&.14>q/I&&(debug_phishing("forms are minor part of page, increasing minScore (small)"),debug_phishing(q),debug_phishing(I),j+=.25);var J=document.querySelectorAll("script"),K={},L=0;if(J)for(var g=0;g<J.length;g++)if(J[g].src){l.href=J[g].src;var G=l.hostname;K[G]=K[G]+1||1,L++}var M=0;for(var N in K)K[N]>2&&K[N]/L>.75&&K[N]<.95&&(k+=.1,debug_phishing("external scripts found, increasing score")),M=K[N];p.length>3&&(debug_phishing("many forms found, increasing minScore"),j+=Math.min(.05*p.length,.2)),document.body.innerHTML.length<4500&&(debug_phishing("small amount of body text, multiplying score"),k*=1.4);var O=document.querySelector('link[rel="shortcut icon"]');O&&O.href&&(l.href=O.href,b(l.hostname)!=G&&(debug_phishing("icon from external domain found"),k+=.1));var P=document.querySelectorAll("p");P.length>50&&(debug_phishing("many paragraphs found, increasing minScore"),j+=.1+Math.min(.025*P.length,.2)),console.log("min "+j),console.log("status",k),k>j&&ipc.sendToHost("phishingDetected");var Q=performance.now();return console.log("phishing scan took "+(Q-c)+" milliseconds"),!0}function getReaderScore(){var a=document.querySelectorAll("p"),b=0;if(a){for(var c=0;c<a.length;c++)b+=Math.max(a[c].textContent.length-100,-30);return b}}function zoomIn(){webFrame||(webFrame=electron.webFrame),_browser_maxZoom>_browser_zoomLevel&&(_browser_zoomLevel+=1),webFrame.setZoomLevel(_browser_zoomLevel)}function zoomOut(){webFrame||(webFrame=electron.webFrame),_browser_zoomLevel>_browser_minZoom&&(_browser_zoomLevel-=1),webFrame.setZoomLevel(_browser_zoomLevel)}function zoomReset(){webFrame||(webFrame=electron.webFrame),_browser_zoomLevel=0,webFrame.setZoomLevel(_browser_zoomLevel)}function isScrolledIntoView(a){var b=a.getBoundingClientRect().top,c=a.getBoundingClientRect().bottom,d=b<window.innerHeight&&c>=0;return d}var electron=require("electron"),ipc=electron.ipcRenderer,webFrame;ipc.on("sendData",function(){var a,b,c,d,e=document.querySelector("[itemprop=price], .price, .offer-price, #priceblock_ourprice, .discounted-price"),f=document.querySelector("[itemprop=priceCurrency], [property=priceCurrency]");e&&(a=e.textContent),/\d/g.test(a)||(a=void 0),a&&-1==a.indexOf("$")&&f&&"en-US"==navigator.language&&(a=(f.content||f.textContent).replace("USD","$")+a);var g=document.querySelector('.star-img, .rating, [itemprop="ratingValue"], [property="ratingValue"]');g||(g=document.querySelector('[class^="rating"], [class^="review"]')),g&&(b=g.title||g.alt||g.content||g.textContent,b=b.replace("rating","").replace("stars","").replace("star","").trim(),console.log("r: "+b),b&&/\d+$/g.test(b)&&(b+=" stars"));var h=document.querySelector('[itemprop="location"], [itemprop="address"]');if(!h)var h=document.querySelector(".adr, .addr, .address");h&&(c=h.textContent.trim()),c&&/,?\d{5}$/g.test(c)&&(c=c.replace(/,?\d{5}$/g,""));var i=document.querySelector('[itemprop="totalTime"], [itemprop="cookTime"]');i&&(d=i.textContent,d=d.replace(/\sm$/g," minutes").replace(/\sh$/g," hours"),d=d.replace("1 hours","1 hour")),console.log("rating: "+b),console.log("price: "+a),console.log("location: "+c);for(var j=getBookmarksText(document,window),k=document.querySelectorAll("iframe"),l=0;l<k.length;k++)try{j+=". "+getBookmarksText(k[l].contentDocument,k[l].contentWindow)}catch(m){}ipc.sendToHost("bookmarksData",{url:window.location.toString(),title:document.title||"",text:j,extraData:{metadata:{price:a,rating:b,location:c,cookTime:d}}})});var contextMenuDefaultPrevented=!1;window.addEventListener("contextmenu",function(a){contextMenuDefaultPrevented=a.defaultPrevented}),ipc.on("getContextData",function(a,b){if(!contextMenuDefaultPrevented){var c=document.elementFromPoint(b.x,b.y);if(c){var d=c.href||c.src;if("IMG"==c.tagName||"PICTURE"==c.tagName)var e=c.src}ipc.sendToHost("contextData",{selection:window.getSelection().toString(),src:d,image:e})}});var tldRegex=/\.(com|net|org|edu|gov|mil)$/g,doubleDomainRegex=/\.(com|net|org|edu|gov|mil|uk|ca|jp|fr|au|us|ru|ch|it|nl|de|es)((\..*(com|net|org|edu|gov|mil))|(\..+(uk|ca|jp|fr|au|us|ru|ch|it|nl|de|es)))/g,didCheckStatus=!1;window.addEventListener("load",function(){didCheckStatus=!0,setTimeout(checkPhishingStatus,1e3)}),document.addEventListener("DOMContentLoaded",checkPhishingStatus),setTimeout(function(){didCheckStatus||checkPhishingStatus()},2500),window.addEventListener("load",function(a){var b=getReaderScore();(b>650||document.querySelector("article")&&b>200)&&(setTimeout(function(){ipc.sendToHost("canReader")},500),setTimeout(function(){ipc.sendToHost("canReader")},2500))});var totalMouseMove=0,verticalMouseMove=0,eventsCaptured=0,documentUnloaded=!1;window.addEventListener("mousewheel",function(a){return verticalMouseMove+=a.deltaY,eventsCaptured++,verticalMouseMove>55&&a.metaKey&&eventsCaptured>1?(verticalMouseMove=-10,zoomOut()):-55>verticalMouseMove&&a.metaKey&&eventsCaptured>1?(verticalMouseMove=-10,zoomIn()):void(a.deltaY>5||a.deltaY<-10||documentUnloaded||(totalMouseMove+=a.deltaX,-150>totalMouseMove?(doneNavigating=!0,window.history.back(),documentUnloaded=!0,setTimeout(function(){documentUnloaded=!1},3e3)):totalMouseMove>100&&(documentUnloaded=!0,window.history.go(1),setTimeout(function(){documentUnloaded=!1},3e3))))}),setInterval(function(){totalMouseMove=0},4e3),setInterval(function(){verticalMouseMove=0,eventsCaptured=0},1e3);var _browser_zoomLevel=0,_browser_maxZoom=9,_browser_minZoom=-8;ipc.on("zoomIn",zoomIn),ipc.on("zoomOut",zoomOut),ipc.on("zoomReset",zoomReset),ipc.on("getKeywordsData",function(a){function b(a){for(var b=["LINK","STYLE","SCRIPT","NOSCRIPT","svg","symbol","title","path","style"],c="",d=a.querySelectorAll("p, h2, h3, h4, li, [name=author], [itemprop=name], .article-author"),e=window.scrollY,f=0;f<d.length;f++){var g=d[f];if(!(!isScrolledIntoView(d[f])&&a==document||"META"==d[f].tagName&&e>500||d[f].textContent.length<50||d[f].querySelector("time, span, div, menu"))&&-1==b.indexOf(g.tagName)){var h=g.textContent||g.content;c+=d[f-1]&&/\.\s*$/g.test(d[f-1].textContent)?" "+h:". "+h}}return c=c.replace(/[\n\t]/g,"")}if(!(getReaderScore()<400&&-1==window.location.toString().indexOf("reader/index.html"))){var c=b(document),d=document.querySelectorAll("iframe");if(d)for(var e=0;e<d.length;e++)try{c+=" "+b(d[e].contentDocument)}catch(a){}var f=require("nlp_compromise"),g=f.spot(c,{}),h=[];g.forEach(function(a){-1!=a.pos_reason.indexOf("noun_capitalised")&&h.push(a.text.replace(/[^a-zA-Z\s]/g,""))}),ipc.sendToHost("keywordsData",{entities:h})}});